{"mappings":"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","sources":["./static/script.js"],"sourcesContent":["/**\n * Modal Stuffs\n */\n\nfunction bindModalOpen() {\n  const openmodal = document.querySelectorAll('.modal-open');\n  for (let i = 0; i < openmodal.length; i++) {\n    openmodal[i].removeEventListener('click', toggleModal);\n    openmodal[i].addEventListener('click', toggleModal);\n  }\n}\n\nconst overlay = document.querySelector('.modal-overlay');\n\nfunction bindModalClose() {\n  overlay.addEventListener('click', toggleModal);\n  const closemodal = document.querySelectorAll('.modal-close');\n  for (var i = 0; i < closemodal.length; i++) {\n    closemodal[i].addEventListener('click', toggleModal);\n  }\n\n  document.onkeydown = function (evt) {\n    evt = evt || window.event;\n    var isEscape = false;\n    if ('key' in evt) {\n      isEscape = evt.key === 'Escape' || evt.key === 'Esc';\n    } else {\n      isEscape = evt.keyCode === 27;\n    }\n    if (isEscape && document.body.classList.contains('modal-active')) {\n      toggleModal();\n    }\n  };\n}\n\nfunction toggleModal() {\n  const body = document.querySelector('body');\n  const modal = document.querySelector('.modal');\n  modal.classList.toggle('opacity-0');\n  modal.classList.toggle('pointer-events-none');\n  body.classList.toggle('modal-active');\n}\n\n/**\n * Main application\n */\n\nlet map;\nlet allReviews = [];\n\ndocument.addEventListener(\n  'DOMContentLoaded',\n  function () {\n    // wake the instance\n    fetch(`${process.env.BACKEND}`);\n    bindModalClose();\n    bindModalOpen();\n    map = new google.maps.Map(document.getElementById('map'), {\n      center: { lat: 1.3521, lng: 103.8198 },\n      zoom: 11,\n    });\n    document.getElementById('search').addEventListener('submit', handleSearch);\n    document\n      .querySelector('#review-form')\n      .addEventListener('submit', handleSubmit);\n  },\n  false,\n);\n\nfunction createMarker(place) {\n  const marker = new google.maps.Marker({\n    map,\n    position: place.geometry.location,\n  });\n  return marker;\n}\n\nfunction handleSearch(e) {\n  e.preventDefault();\n  document.querySelector('.header').classList.add('active');\n  showLoading();\n  const request = {\n    query: `${e.target[0].value}, Singapore`,\n    fields: ['name', 'geometry', 'formatted_address', 'plus_code', 'place_id'],\n  };\n  const service = new google.maps.places.PlacesService(map);\n  promisifySearchQuery(service)(request)\n    .then((results) => {\n      const p = results[0];\n      const lng = p.geometry.location.lng();\n      const lat = p.geometry.location.lat();\n      document.getElementById('address').textContent = p.formatted_address;\n      document.querySelector('#review-form [name=\"formatted_address\"]').value =\n        p.formatted_address;\n      document.querySelector('#review-form [name=\"lng\"]').value = lng;\n      document.querySelector('#review-form [name=\"lat\"]').value = lat;\n      createMarker(p);\n      map.setCenter(p.geometry.location);\n      map.setZoom(17);\n      return searchReviews(lng, lat);\n    })\n    .then((reviews) => {\n      updateReviewState(reviews);\n      loadingDone('map');\n    })\n    .catch(() => {\n      loadingDone('construction');\n    });\n}\n\nfunction showLoading() {\n  document.getElementById('construction-container').style.display = 'none';\n  document.getElementById('map-container').style.display = 'none';\n  document.getElementById('loading').style.display = 'block';\n}\nfunction loadingDone(whatToShow = 'map') {\n  document.getElementById(`${whatToShow}-container`).style.display = 'block';\n  document.getElementById('loading').style.display = 'none';\n}\n\nfunction searchReviews(lng, lat) {\n  return new Promise((resolve) => {\n    fetch(`${process.env.BACKEND}/api/reviews?lat=${lat}&lng=${lng}`)\n      .then((res) => [res.status, res.json()])\n      .then(([status, data]) => {\n        if (status > 299 || status < 200) {\n          return [];\n        }\n        return data;\n      })\n      .then((reviews) => {\n        resolve(\n          reviews.map((v) => {\n            for (const k in v) {\n              v[k] = escapeHTML(v[k]);\n            }\n            return v;\n          }),\n        );\n      })\n      .catch((e) => {\n        console.error(e);\n        resolve([]);\n      });\n  });\n}\n\nfunction promisifySearchQuery(service) {\n  return function (request) {\n    return new Promise((resolve, reject) => {\n      service.findPlaceFromQuery(request, (results, status) => {\n        if (status === google.maps.places.PlacesServiceStatus.OK) {\n          resolve(results);\n        } else {\n          reject(new Error(`Request failed with status ${status}`));\n        }\n      });\n    });\n  };\n}\n\nfunction updateReviewState(reviews) {\n  allReviews = reviews;\n  renderReviewsHTML();\n}\nfunction renderReviewsHTML() {\n  if (allReviews.length === 0) {\n    document.getElementById('review').innerHTML = `\n    <hr />\n    <div class=\"review-entry\">\n        <h4 class=\"text-md\">No reviews nearby here yet.\n            <button class=\"modal-open hover:underline text-blue-500\">Submit one?</button>\n        </h4>\n    </div>`;\n    bindModalOpen();\n    return;\n  }\n  document.getElementById('review').innerHTML = allReviews\n    .map(\n      (r) => `\n    <hr />\n    <div class=\"review-entry\">\n        <h4 class=\"text-md font-bold\">${r.formatted_address} #${r.floor} - ${\n        r.unit_number\n      }</h4>\n        <p class=\"text-sm\">${r.author ? r.author.name : 'Anonymous'}</p>\n        <p class=\"mt-1\">${r.review_text}</p>\n    </div>\n  `,\n    )\n    .join('');\n}\n\nfunction escapeHTML(str) {\n  var p = document.createElement('p');\n  p.appendChild(document.createTextNode(str));\n  return p.innerHTML;\n}\n\nfunction handleSubmit(e) {\n  e.preventDefault();\n  const payload = {\n    formatted_address: document.querySelector(\n      '#review-form [name=\"formatted_address\"]',\n    ).value,\n    lat: parseFloat(document.querySelector('#review-form [name=\"lat\"]').value),\n    lng: parseFloat(document.querySelector('#review-form [name=\"lng\"]').value),\n    floor: document.querySelector('#review-form [name=\"floor\"]').value,\n    unit_number: document.querySelector('#review-form [name=\"unit_number\"]')\n      .value,\n    review_text: document.querySelector('#review-form [name=\"review_text\"]')\n      .value,\n  };\n\n  document\n    .querySelector('#review-form button[type=\"submit\"]')\n    .setAttribute('disabled', true);\n  document.querySelector('#review-form button[type=\"submit\"]').textContent =\n    'Submitting...';\n  fetch(`${process.env.BACKEND}/api/reviews`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify(payload),\n  })\n    .then((resp) => Promise.all([resp.status, resp.json()]))\n    .then(([status, data]) => {\n      if (status > 299 || status < 200) {\n        throw new Error(data.message);\n      }\n      updateReviewState([data, ...allReviews]);\n      toggleModal();\n    })\n    .catch((e) => showFormError(e.message))\n    .finally(() => {\n      document\n        .querySelector('#review-form button[type=\"submit\"]')\n        .removeAttribute('disabled');\n      document.querySelector('#review-form button[type=\"submit\"]').textContent =\n        'Submit';\n    });\n}\n\nfunction showFormError(msg) {\n  const errMsg = document.getElementById('error-message');\n  errMsg.textContent = msg;\n  errMsg.classList.remove('hidden');\n  setTimeout(() => {\n    errMsg.textContent = '';\n    errMsg.classList.add('hidden');\n  }, 5000);\n}\n"],"names":["bindModalOpen","openmodal","document","querySelectorAll","i","length","removeEventListener","toggleModal","addEventListener","overlay","querySelector","body","modal","classList","toggle","map","allReviews","handleSearch","e","preventDefault","add","getElementById","style","display","request","query","target","value","fields","service","Promise","resolve","reject","findPlaceFromQuery","results","status","google","maps","places","PlacesServiceStatus","OK","Error","promisifySearchQuery","PlacesService","then","p","lng","geometry","location","lat","place","textContent","formatted_address","Marker","position","setCenter","setZoom","fetch","res","json","data","reviews","v","k","escapeHTML","catch","console","error","searchReviews","updateReviewState","loadingDone","whatToShow","innerHTML","r","floor","unit_number","author","name","review_text","join","renderReviewsHTML","str","createElement","appendChild","createTextNode","handleSubmit","payload","parseFloat","setAttribute","method","headers","Content-Type","JSON","stringify","resp","all","message","msg","errMsg","remove","setTimeout","showFormError","finally","removeAttribute","closemodal","onkeydown","evt","window","event","key","keyCode","contains","bindModalClose","Map","center","zoom"],"version":3,"file":"index.8be3b25a.js.map"}